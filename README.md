# SaaS Billing Application
## Описание
SaaS Billing Application — это приложение для управления подписками и обработки платежей через ЮKassa.
Оно позволяет пользователям создавать, просматривать, обновлять и удалять подписки,
а также создавать платежи и отслеживать их статусы.

## Стек технологий
- TypeScript,
- NestJS,
- PostgreSQL,
- Docker,
- TypeORM,
- Axios.

## Особенности реализации
Проект был реализован на основе [документации сервиса ЮKassa](https://yookassa.ru/developers/api).
Для оптимизации разработки состав полей API был сокращен до наиболее значимых. Архитектура системы обеспечивает 
полноценное взаимодействие с платежным сервисом на уровне формирования запросов и обработки ответов на события, 
связанные с платежами. Но для реализации проекта не создавался тестовый магазин в ЮKassa, поэтому подписка на вебхуки 
и создание платежа отрабатывают ошибкой аутентификации в API ЮKassa.

## Техническое задание
Спроектировать БД и написать приложение на Node.js для решения следующих задач:
- Есть SaaS приложение, в котором требуется реализовать механизм оплаты за пользование сервисом.
- В качестве биллинга можно использовать любого провайдера банковских услуг, работающего в РФ
  (ЮKassa, ТБанк, Сбер и др.).
- Учитывая, что создать рабочее приложение без наличия кассы невозможно, важно выявить особенности данного процесса и
  найти потенциальные проблемы, которые могут возникнуть.

### Ожидаемый результат:
Репозиторий с исходным кодом, содержащий реализацию необходимых API методов для выполнения оплаты и обработки ошибок.
Также потребуется защитить спроектированную структуру БД.


## Установка и запуск проекта
### Требования
- NestJS 
- PostgreSQL
- Docker 

### Установка зависимостей
1. Клонируйте репозиторий:
   ```bash
   git clone <repository-url>
   cd saas-billings
   ```

2. Установите зависимости:

   ```bash
   npm install
   ```
   
3. Создайте файл .env в корне проекта и скопируйте значения из .env.example.

### Запуск приложения

Для запуска приложения используйте:

   ```bash
   docker-compose up --build
   ```

   ```bash
   npm run start:dev
   ```

## API
### Описание
API разработано с учетом инкапсуляции логики управления подписками, платежами и вебхуками. 
В данной реализации не предусмотрена функциональность, связанная с пользователями, 
поскольку предполагалось, что сервис интегрируется в экосистему, где управление пользователями 
осуществляется отдельным микросервисом. Эти рамки проектирования были специально выбраны для 
целей выполнения тестового задания.

### Эндпоинты

1. **Создание платежа**
   - URL: /payment/create
   - Метод: POST
   - Тело запроса:
   ```json
   {
      "subscriptionId": "123e4567-e89b-12d3-a456-426614174000", 
      "amount": 100.00, 
      "currency": "RUB", 
      "paymentMethod": "bank_card", 
      "description": "Оплата заказа №72" 
   }
   ```
   Описание:

   - subscriptionId: Идентификатор подписки, за которую производится оплата;
   - amount: Стоимость подписки;
   - currency: Валюта, в которой будет произведена оплата;
   - paymentMethod: Способ оплаты;
   - description: Описание платежа.
   

2. **Получение информации о подписке**
   - URL: /subscription/:id
   - Метод: GET
   - Пример идентификатора:
   ```markdown
   123e4567-e89b-12d3-a456-426614174000
   ```
   Описание:
   - id: Идентификатор подписки.
   

3. **Обновление подписки**
   - URL: /subscription/
   - Метод: PATCH
   - Тело запроса:
   ```json
   {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "plan": "premium",  
      "startDate": "2023-01-01T00:00:00Z",
      "endDate": "2023-12-31T00:00:00Z"
   }
   ```
   Описание:
   - id: Идентификатор подписки для обновления;
   - plan: Вид подписки;
   - startDate: Дата начала действия подписки;
   - endDate: Дата окончания действия подписки;


4. **Обработка уведомлений вебхуков**
   - URL: /webhook/notification
   - Метод: POST
   - Тело запроса:
   ```json
   {
      "id": "e44e8088-bd73-43b1-959a-954f3a7d0c54",
      "event": "payment.succeeded",  
      "object": {
         "id": "5c66dee1-81fc-4469-8ca7-8d82da50a004"  
      },
      "created_at": "2023-01-01T00:00:00Z"
   }
   ```

### Дополнительная функциональность
Помимо перечисленных эндпоинтов в проекте реализовано следующее:
1. Метод **create** в сервисе **SubscriptionService**
   - Необходим для создания подписки при создании пользователя в стороннем микросервисе.
2. Метод **delete** в сервисе **SubscriptionService**
   - Необходим для использования в стороннем сервисе при удалении пользователя для удаления его подписки из базы данных.
3. Перевод по расписанию просроченных подписок на бесплатный тип подписки в **SubscriptionService**.
4. Удаление записей о платежах, созданных более чем 24 часа назад, в **PaymentService**.
5. Подписка на вебхуки событий категории **"payment"** при инициализации проекта в **WebhookService**.
6. При получении вебхука проверяется присланный статус: если статус платежа в базе данных выше присланного статуса, 
запись с платежом в бд не обновляется. Таким образом мы решаем проблему получения вебхуков в неправильном порядке и 
проблему повторного получения вебхуков (Еще необходимо проверять ключ идемпотентности вебхука, но, так как API ЮKassa [не 
подразумевает это поле](https://yookassa.ru/developers/using-api/webhooks#using) при отправлении нотификации вебхука, эта логика не была реализована).


## Архитектура базы данных
Схема данных спроектирована с использованием реляционной модели PostgreSQL

### Основные сущности:
   - **Subscription** (Подписки): хранит информацию о подписке пользователя (free, basic, standard, premium) 
и сроках её действия.
   - **Payment** (Платежи): содержит детальные сведения о транзакциях, включая сумму, валюту, статус 
(pending, succeeded и др.) и др.
   - **Notification** (Уведомления): хранит входящие вебхуки от платежного сервиса для того, чтобы отслеживать 
изменения статусов платежей (нужно вынести в аналитическую бд).

### Диаграмма связей:
![Диаграмма связей](/README-img/diagram.png)

### Используемые типы данных:
Для обеспечения целостности данных на уровне БД используются перечисляемые типы (ENUM):

- **Валюты**: 
  - currency_type: 'RUB', 'USD', 'EUR', 'KZT'.
- **Методы оплаты**: 
  - payment_method: 'sberbank_credit', 'alfa_click', 'phone_balance', 'bank_card', 'pay_in_installments', 'cash', 'pay_parts', 'spb', ...
- **События**: статусы событий вебхуков  
  - webhook_event_type: 'payment.waiting_for_capture', 'payment.succeeded', 'payment.canceled'.
- **Статусы платежа**:  
  - payment_status: 'pending', 'waiting_for_capture', 'succeeded', 'canceled'.
- **Виды подписок**:
  - subscription_plan: 'free', 'basic', 'standard', 'premium'.

## Перспективы развития
1. Вынесение таблицы **notifications** в аналитическую базу данных (например в ClickHouse);
2. Добавление трассировок, логирования для контроля запросов;
3. Создание фильтров для ошибок;
4. Покрытие функционала тестами;

